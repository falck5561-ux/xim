{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Josue & Ximena ‚ù§Ô∏è</title>
    
    <link rel="stylesheet" href="{% static 'styles.css' %}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚ù§Ô∏è</text></svg>">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#ff6b81">
    <link rel="apple-touch-icon" href="/static/icon.png">
    <meta name="mobile-web-app-capable" content="yes">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Montserrat:wght@300;400;600&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
        /* --- ESTILOS ESPEC√çFICOS --- */
        
        /* 1. Gestor de M√∫sica */
        .song-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); 
            cursor: pointer; transition: all 0.3s; border-radius: 10px; 
        }
        .song-item:hover { background: rgba(255,255,255,0.1); transform: translateX(5px); }
        .song-item.active-song { background: rgba(255, 71, 87, 0.2); border: 1px solid #ff4757; }
        .song-item-cover {
            width: 40px; height: 40px; border-radius: 50%; margin-right: 15px;
            background: #ff6b81; display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; overflow: hidden; position: relative; box-shadow: 0 0 5px rgba(0,0,0,0.1);
        }
        .song-item-cover img { width: 100%; height: 100%; object-fit: cover; }
        
        .music-upload-zone { 
            border: 2px dashed #555; border-radius: 15px; padding: 30px; 
            text-align: center; color: #888; cursor: pointer; 
            transition: all 0.3s; background: rgba(0,0,0,0.2); 
        }
        .music-upload-zone:hover { border-color: #ff4757; color: #fff; background: rgba(255, 71, 87, 0.1); }
        
        #musicManagerModal .modal-content { background: linear-gradient(145deg, #1a1a1a, #2d2d2d); }

        /* 2. Burbuja de Instrucciones (Sin flecha) */
        .music-hint-bubble {
            position: fixed; bottom: 95px; left: 30px;
            background: rgba(255, 255, 255, 0.95); padding: 10px 15px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border: 2px solid #ff9a9e; color: #ff4757; font-size: 0.8rem; font-weight: 600;
            z-index: 998; pointer-events: none; 
            opacity: 0; transform: translateY(10px); 
            transition: all 0.3s ease; max-width: 200px; line-height: 1.4;
        }
        
        .music-hint-bubble.show-hint,
        .music-player:hover + .music-hint-bubble { opacity: 1; transform: translateY(0); }
        
        .hint-icon { vertical-align: middle; margin: 0 3px; font-size: 1.1em; }
        
        /* 3. Ajuste para videos (Modo Cine Mejorado) */
        .video-cine-box {
            width: 100%; max-width: 800px; /* M√°s ancho */
            /* Altura autom√°tica basada en el contenido, con un m√°ximo para no salirse */
            height: auto; 
            max-height: 70vh; 
            background: #000;
            border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); margin: 0 auto 25px auto;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        /* El video ocupa todo el ancho disponible manteniendo su proporci√≥n */
        .video-cine-box video, .video-cine-box img { 
            width: 100%; 
            height: auto; 
            display: block; 
            max-height: 70vh; /* Limite de altura */
        }
        
        /* 4. Marco de texto ne√≥n */
        .text-frame-neon {
            background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 107, 129, 0.4);
            border-radius: 15px; padding: 30px; position: relative; margin: 0 auto;
            max-width: 800px; box-shadow: inset 0 0 30px rgba(0,0,0,0.5);
        }
        .text-frame-neon::before {
            content: '‚ù§'; position: absolute; top: -18px; left: 50%; transform: translateX(-50%);
            background: #212529; padding: 0 15px; color: #ff4757; font-size: 1.5rem;
        }
    </style>
</head>
<body>

    <audio id="bgMusic" loop><source src="/media/cancion.mp3" type="audio/mpeg"></audio>
    <audio id="birthdayAudio"><source src="/media/cumplea√±os.mp3" type="audio/mpeg"></audio>

    <div id="mainMusicBtn" class="music-player"><i class="bi bi-music-note-beamed text-white fs-4"></i></div>
    
    <div id="musicHint" class="music-hint-bubble romantic-font">
        <i class="bi bi-hand-index-thumb hint-icon"></i> Toque: Pausa <br>
        <i class="bi bi-hdd-network hint-icon"></i> Mant√©n: Men√∫ JX
    </div>

    <button id="scrollTopBtn" class="btn-scroll-top" onclick="scrollToTop()"><i class="bi bi-arrow-up-short"></i></button>

    <div class="container text-center py-5">
        <h1 class="display-1 text-danger romantic-font mb-2 title-pulse" data-aos="fade-down">Josue & Ximena</h1>
        <p class="text-muted mb-4 ls-2" style="letter-spacing: 3px;">31 DE DICIEMBRE DE 2020</p>
        
        <div class="d-flex justify-content-center gap-3 mb-5 flex-wrap" data-aos="fade-up">
            <button class="btn btn-danger rounded-pill px-4 py-2 shadow-sm" onclick="abrirLibro()">üìñ 200 Razones...</button>
            <button class="btn btn-outline-dark rounded-pill px-4 py-2 shadow-sm" onclick="iniciarJuego()">üéÆ Trivia de Amor</button>
            <button class="btn btn-outline-info rounded-pill px-4 py-2 shadow-sm" onclick="abrirModalMusica()">üé∂ Nuestra Canci√≥n</button>
            <button class="btn btn-warning rounded-pill px-4 py-2 shadow-sm" onclick="abrirCumpleanos()">üéÇ ¬°Feliz Cumplea√±os!</button>
            <button id="installBtn" class="btn btn-success rounded-pill px-4 py-2 shadow-sm" style="display: none;">üì≤ Instalar App</button>
        </div>

        <div class="love-timer-container mb-5" data-aos="zoom-in">
            <div class="timer-box"><span class="timer-number" id="years">0</span><span class="timer-label">A√±os</span></div>
            <div class="timer-box"><span class="timer-number" id="days">0</span><span class="timer-label">D√≠as</span></div>
            <div class="timer-box"><span class="timer-number" id="hours">0</span><span class="timer-label">Hrs</span></div>
            <div class="timer-box"><span class="timer-number" id="minutes">0</span><span class="timer-label">Min</span></div>
            <div class="timer-box"><span class="timer-number" id="seconds">0</span><span class="timer-label">Seg</span></div>
        </div>
    </div>

    <div class="container mb-5">
        <div class="timeline-card text-center glass-card" data-aos="fade-up">
            <h3 class="romantic-font text-danger mb-3">Nuestro Camino Juntos üõ§Ô∏è</h3>
            <p class="text-muted mb-4">Desliza para recorrer nuestra historia...</p>
            <div class="px-4"><input type="range" class="timeline-range" id="timelineRange" min="0" max="100" value="0" oninput="updateTimeline()"></div>
            <div class="goal-text romantic-font mt-3" id="goalDisplay">En medio de la incertidumbre de la pandemia, encontrarte fue mi milagro...</div>
        </div>
    </div>

    <div class="container mb-5">
        <h2 class="text-center romantic-font mb-4 text-danger display-5">√Åbrela cuando... üíå</h2>
        <div class="row g-3">
            <div class="col-md-3 col-6" data-aos="fade-up"><div class="letter-card" onclick="leerCarta('hoy')"><div class="letter-icon"><i class="bi bi-calendar-heart"></i></div><h5 class="romantic-font fw-bold">Sea hoy</h5><small class="text-muted">¬°Felices 20 a√±os!</small></div></div>
            <div class="col-md-3 col-6" data-aos="fade-up"><div class="letter-card" onclick="leerCarta('triste')"><div class="letter-icon"><i class="bi bi-cloud-drizzle"></i></div><h5 class="romantic-font fw-bold">Est√©s triste</h5><small class="text-muted">L√©eme para sonre√≠r</small></div></div>
            <div class="col-md-3 col-6" data-aos="fade-up"><div class="letter-card" onclick="leerCarta('extra√±es')"><div class="letter-icon"><i class="bi bi-heart-arrow"></i></div><h5 class="romantic-font fw-bold">Me extra√±es</h5><small class="text-muted">Siempre contigo</small></div></div>
            <div class="col-md-3 col-6" data-aos="fade-up"><div class="letter-card" onclick="leerCarta('dudes')"><div class="letter-icon"><i class="bi bi-gem"></i></div><h5 class="romantic-font fw-bold">Dudes de m√≠</h5><small class="text-muted">Amor eterno</small></div></div>
        </div>
    </div>

    <div class="container pb-5">
        <h2 class="text-center romantic-font mb-5 display-5 text-danger">Nuestra Historia</h2>
        <div class="row g-4">
            {% for momento in momentos %}
            <div class="col-md-6 col-lg-4" data-aos="fade-up">
                <div class="glass-card h-100" 
                    data-id="{{ momento.id }}" data-titulo="{{ momento.titulo }}" 
                    data-fecha="{{ momento.fecha|date:'Y-m-d' }}" data-desc="{{ momento.descripcion }}" 
                    data-video="{% if momento.video %}{{ momento.video.url }}{% endif %}" 
                    data-foto="{% if momento.foto %}{{ momento.foto.url }}{% endif %}">
                    <div class="card-actions">
                        <button class="action-btn" onclick="prepararEdicion(this)" title="Editar"><i class="bi bi-pencil-fill"></i></button>
                        <a href="{% url 'eliminar' momento.id %}" class="action-btn btn-delete" onclick="confirmarBorrado(event, this.href)" title="Borrar"><i class="bi bi-trash-fill text-danger"></i></a>
                    </div>
                    <div onclick="prepararDetalle(this)">
                        <div class="media-thumbnail-container">
                            {% if momento.video %}
                                <video muted loop preload="metadata"><source src="{{ momento.video.url }}" type="video/mp4"></video>
                                <div class="position-absolute top-0 end-0 m-2"><span class="badge bg-dark bg-opacity-75">Video</span></div>
                            {% elif momento.foto %}
                                <img src="{{ momento.foto.url }}">
                            {% endif %}
                        </div>
                        <div class="card-footer-custom">
                            <h3 class="romantic-font text-dark mb-1">{{ momento.titulo }}</h3>
                            <small class="text-muted d-block mb-2">{{ momento.fecha }}</small>
                            <div class="read-more-btn">Ver historia <i class="bi bi-arrow-right-short"></i></div>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12 text-center text-muted py-5"><i class="bi bi-images fs-1 mb-3 d-block opacity-50"></i><p>A√∫n no hay recuerdos. Usa el bot√≥n + para comenzar.</p></div>
            {% endfor %}
        </div>
    </div>

    <div class="container pb-5">
        <div class="footer-surprise" onclick="verSorpresaFinal()">
            <h3 class="romantic-font text-danger">¬øLlegaste hasta aqu√≠? ‚ù§Ô∏è</h3>
            <p class="text-muted">Toca para ver un recordatorio final</p>
        </div>
    </div>

    <button class="btn-add" data-bs-toggle="modal" data-bs-target="#addModal" title="Agregar Recuerdo"><i class="bi bi-plus-lg"></i></button>

    <div class="modal fade" id="musicManagerModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white border-0 shadow-lg" style="border-radius: 20px;">
                <div class="modal-header border-0">
                    <h5 class="modal-title romantic-font text-danger fs-3">üéß DJ del Amor</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="music-upload-zone mb-4" onclick="document.getElementById('songFileInput').click()">
                        <i class="bi bi-cloud-upload fs-1 mb-2"></i>
                        <h6 class="mb-1 fw-bold">Subir Nueva Canci√≥n</h6>
                        <p class="mb-0 small">Toca aqu√≠ para elegir un archivo</p>
                        <input type="file" id="songFileInput" accept="audio/*" style="display: none;" onchange="subirCancion(this)">
                    </div>
                    <h6 class="text-uppercase text-info small ls-2 mb-3 ps-2">Tu Lista de Reproducci√≥n</h6>
                    <div id="songListContainer" style="max-height: 300px; overflow-y: auto; padding-right: 5px;">
                        <div class="text-center text-muted py-3"><div class="spinner-border text-danger spinner-border-sm" role="status"></div><span class="ms-2">Cargando canciones...</span></div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-4 border-top border-secondary pt-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="shuffleMode" style="cursor: pointer;">
                            <label class="form-check-label small" for="shuffleMode">Modo Aleatorio üîÄ</label>
                        </div>
                        <small class="text-white-50 fst-italic">Mant√©n presionado el disco para volver aqu√≠.</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="birthdayModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background-color: transparent; border: none; box-shadow: none;"> 
                <div class="modal-body text-center p-0">
                    <div class="birthday-card">
                        <div class="display-1 mb-3">ü•≥üéâüéÅ</div>
                        <h2 class="rainbow-text mb-4">¬°Feliz Cumplea√±os Ximena!</h2>
                        <p class="lead book-font">Que este d√≠a est√© lleno de alegr√≠a, amor y todo lo que deseas.</p>
                        <div class="mt-4">
                            <div id="birthdayDiscPlayer" class="vinyl-record-css" onclick="toggleBirthdayAudio()">
                                <div class="vinyl-label"><i class="bi bi-music-note-beamed"></i></div>
                            </div>
                        </div>
                        <p class="mt-4 mb-2 book-font" style="color: #666;">¬°Esta canci√≥n es para ti! Toca el disco para escucharla.</p>
                        <small>Toca fuera de la tarjeta para cerrar.</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="momentModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-xl modal-fullscreen-lg-down">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 20px; overflow: hidden;">
                <div class="modal-header border-0 pb-0 bg-white position-relative"><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body pt-0 px-4 pb-5 bg-white">
                    <div class="text-center mb-3"><h2 id="detTitle" class="romantic-font text-danger display-5"></h2><span id="detDate" class="text-muted text-uppercase small ls-2"></span></div>
                    <div class="d-flex justify-content-center mb-4"><div id="detMedia" class="w-100 text-center"></div></div>
                    <div class="text-center mb-3"><i class="bi bi-suit-heart-fill text-danger opacity-25 fs-4"></i></div>
                    <div class="story-paper"><span class="quote-icon quote-start">‚Äú</span><p id="detDesc" class="story-text text-center mb-0"></p><span class="quote-icon quote-end">‚Äù</span></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="addModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content p-4 border-0 shadow">
                <div class="modal-header border-0 position-relative"><h3 class="romantic-font text-danger text-center mb-0 w-100">Nuevo Recuerdo</h3><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="mb-3"><label class="form-label fw-bold">T√≠tulo</label>{{ form.titulo }}</div>
                        <div class="mb-3"><label class="form-label fw-bold">Fecha</label>{{ form.fecha }}</div>
                        <div class="mb-3"><label class="form-label fw-bold">Historia</label>{{ form.descripcion }}</div>
                        <div class="mb-3 border p-2 rounded bg-light"><label class="form-label text-danger fw-bold d-block mb-2"><i class="bi bi-camera-fill me-2"></i>Subir Foto (Opcional)</label>{{ form.foto }}</div>
                        <div class="mb-3 border p-2 rounded bg-light"><label class="form-label text-danger fw-bold d-block mb-2"><i class="bi bi-camera-reels-fill me-2"></i>Subir Video (Opcional)</label>{{ form.video }}</div>
                        <button class="btn btn-danger w-100 rounded-pill mt-2 shadow">Guardar Recuerdo</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content p-4 border-0 shadow"><div class="modal-header border-0 position-relative"><h3 class="romantic-font text-primary text-center mb-0 w-100">Editar Recuerdo</h3><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form method="POST" enctype="multipart/form-data" id="editForm">
                        {% csrf_token %}
                        <div class="mb-3"><label class="form-label fw-bold">T√≠tulo</label><input type="text" name="titulo" id="editTitle" class="form-control"></div>
                        <div class="mb-3"><label class="form-label fw-bold">Fecha</label><input type="date" name="fecha" id="editDate" class="form-control"></div>
                        <div class="mb-3"><label class="form-label fw-bold">Historia</label><textarea name="descripcion" id="editDesc" class="form-control" rows="3"></textarea></div>
                        <div class="mb-3 border p-2 rounded bg-light"><label class="form-label text-danger fw-bold d-block mb-2"><i class="bi bi-camera-fill me-2"></i>Cambiar Foto</label><input type="file" name="foto" class="form-control"></div>
                        <div class="mb-3 border p-2 rounded bg-light"><label class="form-label text-danger fw-bold d-block mb-2"><i class="bi bi-camera-reels-fill me-2"></i>Cambiar Video</label><input type="file" name="video" class="form-control"></div>
                        <button class="btn btn-primary w-100 rounded-pill mt-2 shadow">Guardar Cambios</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="bookModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content book-modal-content border-0">
                <div class="bookmark"></div>
                <div class="modal-header border-0 pb-0 pe-4 pt-3 position-relative"><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button></div>
                <div class="modal-body d-flex flex-column justify-content-between" style="min-height: 450px;">
                    <div id="bookContent" class="flex-grow-1 d-flex flex-column align-items-center justify-content-center p-4">
                        <h4 class="romantic-font text-danger mb-3">200 Razones para Amarte...</h4>
                        <p class="book-font display-6" id="reasonText">Cargando...</p>
                    </div>
                    <div class="d-flex justify-content-between align-items-center px-5 pb-4">
                        <button class="book-nav-btn" onclick="prevPage()">Anterior</button>
                        <button class="book-nav-btn btn-danger" onclick="nextPage()">Siguiente</button>
                    </div>
                    <div class="page-number">P√°gina <span id="pageNum">1</span> de 201</div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="triviaModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content p-4 border-0 shadow-lg" style="border-radius: 20px;">
                <div class="modal-header border-0 pb-0 position-relative"><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body text-center">
                    <h2 class="romantic-font text-danger mb-4 display-5">Trivia de Amor</h2>
                    <div id="question-container"><h4 id="triviaQuestion" class="mb-4 fw-bold text-dark"></h4><div id="triviaOptions" class="d-grid gap-2"></div></div>
                    <div id="win-container" style="display:none;" class="win-card">
                        <div class="display-1 mb-2">üéâ</div>
                        <h2 class="romantic-font text-danger display-6 win-text">¬°Ganaste mi Amor!</h2>
                        <p class="text-muted">Has desbloqueado tus regalos especiales:</p>
                        <hr>
                        <h3 class="book-font fst-italic text-dark">¬°Para que te veas hermosa! üéÅ</h3>
                        <div class="gift-container">
                            <img src="/media/regalo_bolsa.png" alt="Bolsa" class="gift-img">
                            <img src="/media/regalo_sandalias.png" alt="Sandalias" class="gift-img">
                            <img src="/media/bolsa.webp" alt="Bolsa Adicional" class="gift-img">
                            <img src="/media/pijama.webp" alt="Pijama" class="gift-img">
                            <img src="/media/pulsera.webp" alt="Pulsera" class="gift-img">
                        </div>
                        <small class="text-muted d-block mt-3">Espero que te encanten ‚ù§Ô∏è</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="finalBookModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-xl modal-fullscreen-lg-down">
            <div class="modal-content bg-dark text-white border-0 text-center p-4 position-relative overflow-hidden" style="border-radius: 20px;">
                <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="modal"></button>
                <div class="modal-body position-relative" style="z-index: 2;">
                    <h1 class="romantic-font text-info display-4 mb-2">Nunca podr√≠a dejarte...</h1>
                    <p class="text-muted fst-italic mb-4">La raz√≥n #201 es imposible, pero mira esto:</p>
                    <div class="video-cine-box">
                        <video id="bookFinalVideo" controls loop playsinline><source src="/media/xim.mp4" type="video/mp4"></video>
                    </div>
                    <div class="text-frame-neon">
                        <div style="text-align: justify; color: #ddd; line-height: 1.8; font-size: 1.1rem;">
                            <p>S√© que no siempre lo digo, pero admiro c√≥mo enfrentas la vida con una sonrisa incluso en los momentos dif√≠ciles. Tu fuerza, tu bondad y tu manera √∫nica de ver el mundo me inspiran cada d√≠a. Gracias por estar, por quedarte, por dar lo mejor de ti sin rendirte. Eres alguien especial, con un coraz√≥n enorme que deja huellas llenas de cari√±o.</p>
                            <p class="text-center mb-0 mt-3 text-white"><strong>TE QUIERO Y QUIERO QUE NUNCA LO OLVIDES... üåπ</strong></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="finalSurpriseModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-xl modal-fullscreen-lg-down">
            <div class="modal-content bg-dark text-white border-0 text-center p-4 position-relative overflow-hidden" style="border-radius: 20px;">
                <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="modal"></button>
                <div class="modal-body position-relative" style="z-index: 2;">
                    <h1 class="romantic-font text-danger display-4 mb-2">Simplemente Contigo</h1>
                    <p class="text-muted fst-italic mb-4">Un recordatorio de lo mucho que te amo:</p>
                    <div class="video-cine-box">
                        <video id="finalVideo" controls loop playsinline><source src="/media/lindo.mp4" type="video/mp4"></video>
                    </div>
                    <div class="text-frame-neon">
                        <div style="text-align: justify; color: #ddd; line-height: 1.8; font-size: 1.1rem;">
                            <p>No te puedo bajar la luna, pero puedo acompa√±arte cada vez que quieras disfrutar de su belleza. No puedo evitar tus malos momentos o tristezas, pero puedo estar contigo siempre para ayudarte a afrontarlas. Tal vez no pueda darte lo mejor del mundo, pero s√≠ lo mejor de m√≠.</p>
                            <p class="text-center mb-0 mt-3 text-white" style="text-shadow: 0 0 10px rgba(255, 71, 87, 0.5);">
                                <strong>QUIERO QUE SEPAS QUE ERES MI VIDA Y MI MAYOR ALEGR√çA. TE AMO. ‚ù§Ô∏è</strong>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade bg-dark" id="musicModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg bg-dark text-white text-center p-4" style="border-radius: 20px;">
                <div class="modal-header border-0 pb-0 position-relative"><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <i class="bi bi-disc-fill display-1 text-danger mb-3 d-block" style="animation: spin 4s linear infinite;"></i>
                    <h3 class="romantic-font mb-3">Nuestra Canci√≥n Especial</h3>
                    <p class="text-white-50 mb-4">Para escuchar cuando me extra√±es...</p>
                    <div style="position: relative; z-index: 9999;"><audio id="modalAudio" controls class="w-100" style="cursor: pointer;"><source src="/media/letra.mp3" type="audio/mpeg"></audio></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        AOS.init();
        let isMusicPausedByVideo = false;
        let songList = [];
        let currentSongIndex = -1;
        let pressTimer;
        let isShuffle = false;
        let heartCounter = 0;
        let currentPage = 0; 
        let qIdx = 0;

        const musicPlayerBtn = document.getElementById('mainMusicBtn');
        const musicHint = document.getElementById('musicHint'); 
        const bgMusic = document.getElementById('bgMusic');
        const modalMusic = document.getElementById('modalAudio');
        const birthdayAudio = document.getElementById('birthdayAudio');
        const birthdayDiscPlayer = document.getElementById('birthdayDiscPlayer');
        const scrollBtn = document.getElementById('scrollTopBtn');
        const shuffleCheckbox = document.getElementById('shuffleMode');
        const installBtn = document.getElementById('installBtn');

        const baseReasons = ["porque te quiero", "porque te amo", "porque te adoro", "porque amo tus cachetitos", "porque con saludarme me haces el dia", "porque eres mi cielo en la tierra", "porque te preocupas por mi", "porque entiendes como estoy sin decirte nada", "porque contigo soy yo mismo", "porque me conoces mas que nadie y aun asi sigues aqui",
        "porque no me imagino mi vida sin ti", "porque solo quiero un futuro a tu lado", "porque gracias a ti creo en un para siempre", "porque quiero compartir todo contigo", "porque quiero estar siempre contigo", "por ti haria hasta lo imposible", "por ti soy el mas feliz del mundo", "porque tu sonrisa me encanta", "porque tu mirada me hipnotiza", "porque tu alegria es lo que siempre deseo",
        "porque tu bienestar es lo mas importante para mi", "porque tu felicidad es mi mision", "porque me encantan tus besos", "porque iluminas mis dias aun mas que el sol", "porque eres la mayor bendicion", "porque te gusta verme feliz", "porque contigo siempre quiero intentar todo", "porque sonries con mis tonterias que hago o digo", "porque por ti soy valiente", "por ti tengo fuerza para enfrentar todo",
        "porque quiero darte todo", "porque me haces ser mejor de lo que soy", "porque cuando hablo de ti mi creen loco de amor", "porque contigo sue√±o a diario", "me haces sentir especial", "porque eres la razon de mi existir", "porque te veo siempre aunque no estes basta con cerrar los ojos y ahi estas", "por ti me aferro a la vida", "aunque por ti daria mi vida", "porque eres mi debilidad",
        "porque eres la persona mas maravillosa de este universo", "porque sin ti no se vivir", "porque eres la sinfonia de mi corazon", "porque mi sangre hierve por ti", "porque elevas al maximo mi autoestima", "porque soy todo tuyo", "porque nos pertenecemos mutuamente", "porque no te puedo mentir", "el solo recordarte me hace suspirar", "porque para mi eres perfecta",
        "porque tenemos nuestro peque√±o universo solo para nosotros dos", "porque eres mi devocion", "porque deseo siempre escucharte", "solo tu calor me abriga", "me encantan tus detalles", "solo existimos nosotros dos al estar juntos", "porque lo que siento por ti es interminable", "porque cada dia te lo dedico a ti", "porque contigo me gobierna la felicidad", "porque te secuestraria para estar siempre juntos",
        "porque eres la luz de todos mis caminos", "porque te deseo", "porque me vuelves loco por ti", "eres el escape divino hacia el cielo", "porque adoro tu aroma", "porque tenemos cosas en comun", "porque tenemos cosas tan distintas", "porque conquistaste todo mi ser", "porque eres mi vida", "porque eres mi mundo",
        "porque eres mi alma gemela", "porque eres todo para mi", "contigo todo es mas bello", "contigo todo lo disfruto al maximo", "porque mi corazon tiene tu nombre tatuado", "porque me haces perder la razon", "porque me haces suspirar tan profundamente", "porque me haces sonreir como nunca lo he hecho", "por todos los bellos momentos que compartiremos juntos", "por todas las sonrisas que tendremos",
        "por todas las locuras que haremos", "porque no puedo dejar de pensar en ti", "porque muero por despertar a tu lado", "porque te necesito", "porque me encanta cuando cantas", "por cada abrazo que me das", "por nuestros momentos de ser cursis", "porque eres la unica en mi vida", "porque me encantan tus mensajes cursis", "porque me has mostrado lo que es querer de verdad",
        "porque gracias a ti e sentido lo que es que te quieran", "porque me soportas dia a dia", "por esos momentos cuando nos quedabamos dormidos juntos", "por estar siempre ahi", "por aguantar cuando pasaba por algo dificil", "por nuestras conversaciones hasta la madrugada", "por todos nuestros planes que tenemos juntos", "porque cada segundo a tu lado a sido increible", "porque me has hecho vivir la mejor etapa de mi vida", "por esas salidas a cualquier lado caminando de la mano",
        "por tus caricias", "por toda tu dulzura que tienes", "porque conviertes mis lagrimas en sonrisas", "porque eres mi sue√±o hecho realidad", "porque cada segundo que estamos lejos te extra√±o", "porque jamas olvidare nuestro primer bes", "ni la primera vez que fuimos al cine", "o todo lo que nos pasa cuando vamos al cine", "por las canciones que me dedicas", "porque no puedo evitar amarte",
        "porque me haces sentir tan afortunado al estar a tu lado", "porque siempre me das animo", "porque siempre te trato como a una princesa", "porque aguantas mi mal caracter", "por hacerme sentir guapo", "por estar conmigo en la prepa aunque tengas sue√±o", "por dejarme acompa√±arte hasta tu casa", "por ese 3 de noviembre que me acompa√±aste aunque morias de nervios", "por ese 15 de febrero que fue mi competencia", "por estar ahi aunque tuvieras sue√±o y hambre",
        "por esos gritos de apoyo que hizo que diera todo", "por querer lo mejor para mi", "porque siempre te quiero ver", "por haberte fijado en mi", "por todos esos momentos que comemos juntos", "porque siempre evito pelear contigo", "porque me encanta verte jugar", "porque me gusta acompa√±arte a cualquier lado y hora con tal de verte jugar", "por cada sabado que pasamos todo el dia juntos", "por esas salidas al parque que hasta vimos una vaca",
        "por cuando vamos por crepas aunque esten caras pero te encantan", "porque me encantaria detener el tiempo cuando estoy a tu lado", "porque quiero besarte por todas partes: tus labios, tu frente , tu cuello, y mucho mas", "porque me encanta hacerte consquillas", "porque para mi siempre seras la mas hermosa de todas", "no importa si te veo en pijama, o con vestido, o casual siempre me fascinas", "porque solo nosotros nos entendemos", "porque me encanta mirarte", "porque me gusta cuando nos vemos a los ojos", "porque me ense√±as tu lengua apretando los ojos",
        "porque eres increiblemente perfecta", "porque no quiero perderte", "por todas las sorpresas que faltan por darte", "por estar ahi cuando mas te necesito", "porque doy todo por sacarte una sonrisa cuando estas triste", "porque quiero convertir tus lagrimas en sonrisas", "porque gracias a ti todo es mas bello", "porque aparte de mi novia eres mi amiga", "porque te cuido", "porque nuestro amor es sincero",
        "porque a tu lado horas son segundos", "por nuestros momentos de risa", "por aguantar mi borrachera", "por serme fiel", "por nuestros apodos cari√±osos que tenemos", "porque te entrego mi corazon y no hay devoluciones", "porque no quiero olvidarte nunca", "por todos los viajes que haremos", "porque con una mirada basta para enamorarme", "porque odio que agarres mis cachetes pero es lindo",
        "porque cada dia intento enamorarte", "porque contigo no busco una historia con final feliz sino una historia sin final", "porque aceptas mis defectos", "y yo los tuyos", "porque el destino nos unio", "por tu comprension", "porque contigo no existe la monotonia", "por compartir tu vida conmigo", "porque eres increible", "porque has dejado huella en mi vida",
        "por nuestro primer 'te amo'", "por todos los dias que quedan por vernos", "porque me das esperanza para creer en el amor", "por todo lo que me ense√±as", "por como me haces piojito", "por tu cara de ni√±a buena", "por los peque√±os detalles", "por cada palabra que dices", "por lo cari√±osa que eres conmigo", "porque me dejas sin palabras",
        "por las ganas que tengo de verte", "por que eres divertida", "porque nunca e sido asi con nadie mas", "porque que quiero ser el ultimo en tu vida", "porque confio en ti", "porque siempre me haces reir", "por tu amor incondicional", "por todo lo que me escribes en mi piel", "por todos los mensajes que hemos enviado", "porque eres imprescindible en mi vida",
        "porque nunca nos quedamos sin tema de conversacion", "porque te voy a comer a besos cuando te vea", "porque me gusta apapacharte", "porque me encanta que te acurruques en mi", "porque me gusta cuando duermes a mi lado y te hago piojito", "porque cada dia te amo mas", "porque contigo ya no tengo verg√ºenza de nada", "por todos esos minutos hablando por telefono", "por todo lo que nos queda", "porque cada momento a tu lado es especial e inolvidable"];
        
        let allPages = []; 
        for(let i=0; i<baseReasons.length; i++) { allPages.push(`<strong>Raz√≥n #${i+1}:</strong><br>${baseReasons[i]}`); }
        allPages.push("<strong>Raz√≥n #201:</strong><br>Una raz√≥n para dejarte...<br><button class='btn-reveal' onclick='verRazonFinalLibro()'>Ver Raz√≥n</button>");

        const triviaQuestions = [{ q: "¬øD√≥nde fue nuestro primer beso? üíã", opts: ["Escuela", "Parque", "Cine"], ans: 0 }, { q: "¬øCu√°nto me amas? üìà", opts: ["10", "100", "Infinito"], ans: 2 }, { q: "¬øQu√© me regalaste primero? üéÅ", opts: ["Carta", "Lechuga ü•¨", "Chocolate"], ans: 1 }];

        function leerCarta(tipo) {
            let t="", b="", i="";
            if(tipo==='hoy'){ t="¬°Felices 20 A√±os Amor!"; b="Estos 5 a√±os vi√©ndote crecer han sido el mejor regalo. Cumplir 20 es solo el inicio de tu mejor √©poca, y mi mayor orgullo es estar ah√≠, en primera fila, am√°ndote en cada paso."; i="üéÇ"; }
            else if(tipo==='triste'){ t="Si est√°s triste..."; b=`<span style="text-align:left; display:block;">Precisamente no entiendo cu√°ndo tu sonrisa, tus emociones, tus sentimientos y tus palabras empezaron a ser prioridad para m√≠.<br><br>Exactamente no podr√≠a explicar lo que siento por ti, solo s√© que mi coraz√≥n palpita m√°s r√°pido cuando estoy cerca de ti.<br><br>Solo s√© que cuando estoy a tu lado los dem√°s son indiferentes para m√≠. T√∫ eres lo que pienso cuando despierto y lo que pienso antes de dormir. No puedo dejar de pensar y hablar de ti.</span>`; i="üåà"; }
            else if(tipo==='extra√±es'){ t="Si me extra√±as..."; b="Cierra los ojos. No estoy lejos. Estoy en cada latido que se acelera cuando piensas en m√≠. La distancia es una prueba que nuestro amor supera a diario. Te extra√±o tanto como t√∫ a m√≠."; i="‚ù§Ô∏è"; }
            else if(tipo==='dudes'){ t="Si dudas de nosotros..."; b="M√≠rame a los ojos (o a este mensaje). T√∫ eres mi prioridad absoluta. No hay nadie m√°s. Desde que llegaste, el resto del mundo se volvi√≥ borroso. Mi lealtad es tuya, hoy y siempre."; i="üíç"; }
            Swal.fire({ title: `<span class="romantic-font" style="font-size:2.5rem; color:#ff6b81">${t}</span>`, html: `<div style="font-family:'Playfair Display'; font-style:italic; font-size:1.1rem; line-height:1.6">${b}</div><div style="font-size:3rem; margin-top:15px;">${i}</div>`, confirmButtonText: 'Te amo', confirmButtonColor: '#ff6b81', background: '#fffdf9', width: 600, padding: '2.5em', backdrop: `rgba(255, 107, 129, 0.1)` });
        }

        function abrirLibro() { 
            currentPage = 0; updateBook(); 
            new bootstrap.Modal(document.getElementById('bookModal')).show(); 
        }

        function updateBook() { 
            document.getElementById('reasonText').innerHTML = allPages[currentPage]; 
            document.getElementById('pageNum').innerText = currentPage + 1; 
            document.getElementById('bookContent').style.opacity = 0; 
            setTimeout(() => document.getElementById('bookContent').style.opacity = 1, 200); 
        }

        function nextPage() { if(currentPage < allPages.length - 1) { currentPage++; updateBook(); } }
        function prevPage() { if(currentPage > 0) { currentPage--; updateBook(); } }

        function verRazonFinalLibro() { 
            const bookModalEl = document.getElementById('bookModal');
            const modal = bootstrap.Modal.getInstance(bookModalEl);
            if (modal) modal.hide();

            new bootstrap.Modal(document.getElementById('finalBookModal')).show(); 
            const v = document.querySelector('#finalBookModal video'); 
            if(v) { v.currentTime = 0; v.play(); } 
            lanzarConfetiSuave(); 
        }

        function iniciarJuego() { 
            qIdx = 0; 
            document.getElementById('question-container').style.display = 'block'; 
            document.getElementById('win-container').style.display = 'none'; 
            showQ(); 
            new bootstrap.Modal(document.getElementById('triviaModal')).show(); 
        }

        function showQ() { 
            const q = triviaQuestions[qIdx]; 
            document.getElementById('triviaQuestion').innerText = q.q; 
            const div = document.getElementById('triviaOptions'); div.innerHTML = ''; 
            q.opts.forEach((o, i) => { 
                const b = document.createElement('button'); b.className = 'trivia-option'; b.innerText = o; 
                b.onclick = () => { 
                    if(i === q.ans) { 
                        b.style.background='#d4edda'; b.style.borderColor='#198754'; 
                        setTimeout(()=>{ qIdx++; if(qIdx < triviaQuestions.length) showQ(); else showWin(); }, 500); 
                    } else { 
                        b.classList.add('shake'); setTimeout(()=>b.classList.remove('shake'), 500); 
                    } 
                }; 
                div.appendChild(b); 
            }); 
        }

        function showWin() { 
            document.getElementById('question-container').style.display = 'none'; 
            document.getElementById('win-container').style.display = 'block'; 
            lanzarConfetiSuave(); 
        }

        function abrirModalMusica() { 
            bgMusic.pause(); 
            musicPlayerBtn.classList.remove('playing');
            new bootstrap.Modal(document.getElementById('musicModal')).show();
            modalMusic.currentTime = 0;
            modalMusic.play();
        }

        function abrirCumpleanos() { 
            bgMusic.pause(); 
            musicPlayerBtn.classList.remove('playing');
            new bootstrap.Modal(document.getElementById('birthdayModal')).show(); 
            birthdayAudio.currentTime = 0;
            birthdayAudio.play().then(() => { birthdayDiscPlayer.classList.add('playing'); }).catch(e => console.log("Auto-play prevent", e));
            lanzarConfetiCumple();
        }

        function verSorpresaFinal() { 
            new bootstrap.Modal(document.getElementById('finalSurpriseModal')).show(); 
            const v = document.querySelector('#finalSurpriseModal video'); 
            if(v) { v.currentTime = 0; v.play(); } 
            lanzarConfetiSuave(); 
        }

        function toggleBirthdayAudio() {
            if (birthdayAudio.paused) {
                birthdayAudio.play().catch(e => console.error(e));
                birthdayDiscPlayer.classList.add('playing');
            } else {
                birthdayAudio.pause();
                birthdayDiscPlayer.classList.remove('playing');
            }
        }

        function lanzarConfetiCumple() {
             var duration = 3000; var animationEnd = Date.now() + duration; var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 9999 };
             var interval = setInterval(function() {
                 var timeLeft = animationEnd - Date.now();
                 if (timeLeft <= 0) return clearInterval(interval);
                 var particleCount = 50 * (timeLeft / duration);
                 confetti(Object.assign({}, defaults, { particleCount, origin: { x: Math.random()*0.2 + 0.1, y: Math.random() - 0.2 }, colors: ['#ff4757', '#ffb3d1', '#fff'] }));
                 confetti(Object.assign({}, defaults, { particleCount, origin: { x: Math.random()*0.2 + 0.7, y: Math.random() - 0.2 }, colors: ['#ff4757', '#ffb3d1', '#fff'] }));
             }, 250);
        }

        function lanzarConfetiSuave() { 
            var end = Date.now() + 3000; 
            (function frame() { 
                confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 }, shapes: ['heart'], colors: ['#ff4757', '#ff6b81', '#ffffff'], gravity: 0.3, drift: 0, ticks: 200, scalar: 2 }); 
                confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 }, shapes: ['heart'], colors: ['#ff4757', '#ff6b81', '#ffffff'], gravity: 0.3, drift: 0, ticks: 200, scalar: 2 }); 
                if (Date.now() < end) requestAnimationFrame(frame); 
            }()); 
        }

        function abrirDetalle(titulo, fecha, descripcion, videoUrl, fotoUrl) {
            document.getElementById('detTitle').innerText = titulo; 
            document.getElementById('detDate').innerText = fecha; 
            document.getElementById('detDesc').innerText = descripcion;
            const media = document.getElementById('detMedia'); 
            media.innerHTML = '';
            
            const wrapper = document.createElement('div');
            wrapper.classList.add('video-cine-box');

            if(videoUrl) { 
                const v = document.createElement('video'); v.src = videoUrl; v.controls = true; v.autoplay = true; v.loop = true; v.playsInline = true; 
                wrapper.appendChild(v); media.appendChild(wrapper); v.oncanplay = () => v.play(); 
                if(!bgMusic.paused){ bgMusic.pause(); musicPlayerBtn.classList.remove('playing'); isMusicPausedByVideo = true; }
            } 
            else if(fotoUrl) { 
                const i = document.createElement('img'); i.src = fotoUrl; wrapper.appendChild(i); media.appendChild(wrapper); 
            }
            new bootstrap.Modal(document.getElementById('momentModal')).show();
        }

        function prepararEdicion(btn) { const c = btn.closest('.glass-card'); document.getElementById('editForm').action = '/editar/' + c.dataset.id + '/'; document.getElementById('editTitle').value = c.dataset.titulo; document.getElementById('editDate').value = c.dataset.fecha; document.getElementById('editDesc').value = c.dataset.desc; new bootstrap.Modal(document.getElementById('editModal')).show(); }
        function prepararDetalle(e) { const c = e.closest('.glass-card'); abrirDetalle(c.dataset.titulo, c.dataset.fecha, c.dataset.desc, c.dataset.video, c.dataset.foto); }

        function confirmarBorrado(e, url) {
            e.preventDefault();
            Swal.fire({ title: '<span class="romantic-font" style="color:#ff4757; font-size: 2.5rem;">¬øBorrar?</span>', text: "No podr√°s recuperarlo", icon: 'warning', showCancelButton: true, confirmButtonColor: '#ff4757', cancelButtonColor: '#fab1a0', confirmButtonText: 'S√≠', cancelButtonText: 'No', background: '#fff0f3' }).then((result) => { if (result.isConfirmed) window.location.href = url; });
        }

        function toggleMusic() {
            if(bgMusic.paused) { 
                bgMusic.play(); 
                musicPlayerBtn.classList.add('playing'); 
            } else { 
                bgMusic.pause(); 
                musicPlayerBtn.classList.remove('playing'); 
            }
        }

        function handleStart() {
            musicHint.classList.add('show-hint');
            pressTimer = setTimeout(() => {
                new bootstrap.Modal(document.getElementById('musicManagerModal')).show();
                cargarCanciones();
                pressTimer = null; 
                musicHint.classList.remove('show-hint'); 
            }, 800); 
        }
        
        function handleEnd(e) {
            musicHint.classList.remove('show-hint');
            if (pressTimer) {
                clearTimeout(pressTimer);
                toggleMusic();
            }
        }

        function cargarCanciones() {
            fetch('/api/canciones/')
            .then(r => r.json())
            .then(data => {
                songList = data.canciones;
                renderSongList();
            });
        }

        function renderSongList() {
            const container = document.getElementById('songListContainer');
            container.innerHTML = '';
            if(songList.length === 0) {
                container.innerHTML = '<div class="text-muted text-center py-3">No hay canciones.</div>';
                return;
            }
            
            songList.forEach((song, index) => {
                const div = document.createElement('div');
                const isActive = bgMusic.src.includes(song.archivo);
                div.className = `song-item ${isActive ? 'active-song' : ''}`;
                
                let actionsHtml = '';
                if(!song.es_default) {
                    actionsHtml = `
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-light border-0" onclick="event.stopPropagation(); renombrarCancion(${song.id}, '${song.titulo}')"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-sm btn-outline-danger border-0" onclick="event.stopPropagation(); eliminarCancion(${song.id})"><i class="bi bi-trash"></i></button>
                        </div>
                    `;
                } else {
                    actionsHtml = '<small class="text-muted fst-italic me-2">Predeterminada</small>';
                }

                div.innerHTML = `
                    <div class="d-flex align-items-center text-truncate" style="max-width: 70%;">
                        <div class="song-item-cover">
                            ${isActive ? '<i class="bi bi-play-fill text-white fs-4"></i>' : '<i class="bi bi-music-note-beamed"></i>'}
                        </div>
                        <strong class="text-truncate">${song.titulo}</strong>
                    </div>
                    ${actionsHtml}
                `;
                
                div.onclick = () => playSong(song.archivo, index);
                container.appendChild(div);
            });
        }

        function playSong(url, index) {
            currentSongIndex = index;
            bgMusic.src = url;
            bgMusic.play();
            musicPlayerBtn.classList.add('playing');
            renderSongList();
        }

        function eliminarCancion(id) {
            Swal.fire({ title: '¬øBorrar?', text: "No se podr√° recuperar", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'S√≠', background: '#333', color: '#fff' }).then((result) => {
                if (result.isConfirmed) {
                    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    fetch(`/api/eliminar-cancion/${id}/`, { method: 'POST', headers: { 'X-CSRFToken': csrftoken } }).then(r => r.json()).then(data => { if(data.status === 'ok') cargarCanciones(); });
                }
            });
        }

        function renombrarCancion(id, nombreActual) {
            Swal.fire({ title: 'Renombrar', input: 'text', inputValue: nombreActual, showCancelButton: true, confirmButtonText: 'Guardar', background: '#333', color: '#fff' }).then((result) => {
                if (result.isConfirmed && result.value) {
                    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    fetch(`/api/renombrar-cancion/${id}/`, { method: 'POST', body: JSON.stringify({titulo: result.value}), headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/json' } }).then(r => r.json()).then(data => { if(data.status === 'ok') cargarCanciones(); });
                }
            });
        }

        function subirCancion(input) {
            const file = input.files[0];
            if(!file) return;
            Swal.fire({ title: 'Nombre de la canci√≥n', input: 'text', inputValue: file.name.replace(/\.[^/.]+$/, ""), showCancelButton: true, confirmButtonText: 'Subir', confirmButtonColor: '#ff4757' }).then((result) => {
                if (result.isConfirmed) {
                    const formData = new FormData();
                    formData.append('titulo', result.value);
                    formData.append('archivo', file);
                    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    fetch('/api/subir-cancion/', { method: 'POST', body: formData, headers: { 'X-CSRFToken': csrftoken } }).then(r => r.json()).then(data => { if(data.status === 'ok') { Swal.fire({icon: 'success', title: '¬°Canci√≥n Subida!', timer: 1500, showConfirmButton: false}); cargarCanciones(); } });
                }
            });
        }

        if(shuffleCheckbox) shuffleCheckbox.addEventListener('change', (e) => { isShuffle = e.target.checked; });
        
        bgMusic.addEventListener('ended', () => {
            if(isShuffle && songList.length > 0) {
                let nextIndex;
                do { nextIndex = Math.floor(Math.random() * songList.length); } while (songList.length > 1 && nextIndex === currentSongIndex);
                playSong(songList[nextIndex].archivo, nextIndex);
            } else { bgMusic.currentTime = 0; bgMusic.play(); }
        });

        musicPlayerBtn.addEventListener('mousedown', handleStart);
        musicPlayerBtn.addEventListener('mouseup', handleEnd);
        musicPlayerBtn.addEventListener('touchstart', (e) => { e.preventDefault(); handleStart(); });
        musicPlayerBtn.addEventListener('touchend', (e) => { e.preventDefault(); handleEnd(); });

        document.addEventListener('mousemove', function(e) { 
            heartCounter++; 
            if (heartCounter % 8 === 0) { 
                const heart = document.createElement('div'); heart.classList.add('heart-trail'); heart.innerHTML = '‚ù§Ô∏è'; 
                heart.style.left = e.pageX + 'px'; heart.style.top = e.pageY + 'px'; 
                document.body.appendChild(heart); setTimeout(() => { heart.remove(); }, 1500); 
            } 
        });

        window.onscroll = function() { if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) { scrollBtn.classList.add('visible'); } else { scrollBtn.classList.remove('visible'); } };
        function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }

        const startDate = new Date(2020, 11, 31, 21, 0, 0); 
        setInterval(() => {
            const now = new Date(); const diff = now - startDate;
            document.getElementById('years').innerText = Math.floor(diff / (1000 * 60 * 60 * 24 * 365.25));
            document.getElementById('days').innerText = Math.floor((diff / (1000 * 60 * 60 * 24)) % 365.25);
            document.getElementById('hours').innerText = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            document.getElementById('minutes').innerText = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            document.getElementById('seconds').innerText = Math.floor((diff % (1000 * 60)) / 1000);
        }, 1000);

        function updateTimeline() {
            const val = document.getElementById('timelineRange').value;
            const display = document.getElementById('goalDisplay');
            if(val < 20) display.innerText = "En medio de la incertidumbre de la pandemia, encontrarte fue mi milagro: entre mascarillas y distancia, descubr√≠ que el amor puede florecer incluso en los momentos m√°s dif√≠ciles üò∑‚ù§Ô∏è‚ú®";
            else if(val < 45) display.innerText = "La prepa no fue solo estudiar y ex√°menes, fue aprender a crecer contigo, a re√≠r en los pasillos, a superar cada obst√°culo de la mano, y a descubrir que juntos somos invencibles üéìüí™‚ù§Ô∏è";
            else if(val < 70) display.innerText = "La universidad nos reta, pero tambi√©n nos regala la oportunidad de construir sue√±os lado a lado. Cada desvelo, cada logro, cada paso nos acerca m√°s a la vida que imaginamos üöÄüìö‚ù§Ô∏è";
            else if(val < 99) display.innerText = "Nuestro futuro no es solo una boda, es la promesa de despertar juntos cada d√≠a, de llenar nuestra casa de risas, de amor y de recuerdos que a√∫n nos esperan üíçüè†üí´";
            else {
                // FINAL (100%)
                display.innerText = "M√°s all√° de todo lo que hemos vivido y lo que vendr√°, lo √∫nico que s√© con certeza es que contigo quiero escribir cada cap√≠tulo de mi vida ‚ù§Ô∏èüìñ‚ú®";
                
                if(!bgMusic.paused){
                    bgMusic.pause();
                    musicPlayerBtn.classList.remove('playing');
                }

                Swal.fire({ 
                    title: '<span class="romantic-font text-danger">¬°Eternidad!</span>', 
                    html: `
                        <p class="lead text-muted" style="font-family:'Playfair Display'; font-style:italic;">
                            M√°s all√° de todo lo que hemos vivido y lo que vendr√°, lo √∫nico que s√© con certeza es que contigo quiero escribir cada cap√≠tulo de mi vida ‚ù§Ô∏èüìñ‚ú®
                        </p>
                        
                        <div class="video-cine-box mb-3" style="height: auto; max-height: 60vh;">
                            <video id="timelineVideo" controls autoplay playsinline style="width: 100%; height: 100%; object-fit: contain;">
                                <source src="/media/beso.mp4" type="video/mp4">
                                Tu navegador no soporta videos.
                            </video>
                        </div>

                        <button class="btn btn-danger rounded-pill px-4 mt-2" onclick="Swal.close()">Te Amo</button>
                    `, 
                    showConfirmButton: false, 
                    background: '#fffcf5', 
                    backdrop: `rgba(255,215,0,0.2)`, 
                    padding: '2em',
                    width: '800px',
                    willClose: () => {
                        const v = document.getElementById('timelineVideo');
                        if(v) v.pause();
                    }
                });
                
                lanzarConfetiSuave();
            }
        }

        document.getElementById('birthdayModal').addEventListener('hide.bs.modal', () => { birthdayAudio.pause(); birthdayDiscPlayer.classList.remove('playing'); });
        document.getElementById('musicModal').addEventListener('hide.bs.modal', () => { modalMusic.pause(); modalMusic.currentTime = 0; });
        document.getElementById('momentModal').addEventListener('hide.bs.modal', () => { 
            const v = document.querySelector('#momentModal video'); if(v) { v.pause(); v.currentTime = 0; v.src = ""; v.load(); } 
            if(isMusicPausedByVideo){ bgMusic.play(); musicPlayerBtn.classList.add('playing'); isMusicPausedByVideo = false; }
        });

        ['finalSurpriseModal', 'finalBookModal'].forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('show.bs.modal', () => { if(!bgMusic.paused){ bgMusic.pause(); musicPlayerBtn.classList.remove('playing'); isMusicPausedByVideo = true; } });
            el.addEventListener('hide.bs.modal', () => { const vid = el.querySelector('video'); if(vid) { vid.pause(); vid.currentTime = 0; } if(isMusicPausedByVideo){ bgMusic.play(); musicPlayerBtn.classList.add('playing'); isMusicPausedByVideo = false; } });
        });

        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('/static/sw.js'); }
        let deferredPrompt; 
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; installBtn.style.display = 'inline-block'; installBtn.classList.add('animate__animated', 'animate__pulse', 'animate__infinite'); });
        installBtn.addEventListener('click', async () => { if (!deferredPrompt) return; deferredPrompt.prompt(); const { outcome } = await deferredPrompt.userChoice; deferredPrompt = null; if(outcome === 'accepted'){ installBtn.style.display = 'none'; } });
        window.addEventListener('appinstalled', () => { installBtn.style.display = 'none'; });

    </script>
</body>
</html>